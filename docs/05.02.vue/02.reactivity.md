# å“åº”å¼

## vue3 çš„å“åº”å¼åº“æ˜¯ç‹¬ç«‹å‡ºæ¥çš„ï¼Œå®ƒå•ç‹¬ä½¿ç”¨çš„æ—¶å€™æ˜¯ä»€ä¹ˆæ•ˆæœ {#p0-vue3-reactivity}

 è¯¥è¯é¢˜æ¶‰åŠçš„ç›¸å…³å†…å®¹

* åŸç†ï¼šProxyã€trackã€trigger
* æ–°å¢å±æ€§
* éå†åæ–°å¢
* éå†ååˆ é™¤æˆ–è€…æ¸…ç©º
* è·å– keys
* åˆ é™¤å¯¹è±¡å±æ€§
* åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨
* æ€§èƒ½

æ¨èé˜…è¯»æ–‡æ¡£ï¼š [èµ„æ–™](https://juejin.cn/post/6844904122479542285)

 å“åº”å¼ä»“åº“

Vue3 ä¸åŒäº Vue2 ä¹Ÿä½“ç°åœ¨æºç ç»“æ„ä¸Šï¼ŒVue3 æŠŠè€¦åˆæ€§æ¯”è¾ƒä½çš„åŒ…åˆ†æ•£åœ¨ `packages` ç›®å½•ä¸‹å•ç‹¬å‘å¸ƒæˆ `npm` åŒ…ã€‚ è¿™ä¹Ÿæ˜¯ç›®å‰å¾ˆæµè¡Œçš„ä¸€ç§å¤§å‹é¡¹ç›®ç®¡ç†æ–¹å¼ `Monorepo`ã€‚

å…¶ä¸­è´Ÿè´£å“åº”å¼éƒ¨åˆ†çš„ä»“åº“å°±æ˜¯ `@vue/reactivity`ï¼Œå®ƒä¸æ¶‰åŠ Vue çš„å…¶ä»–çš„ä»»ä½•éƒ¨åˆ†ï¼Œæ˜¯éå¸¸éå¸¸ ã€Œæ­£äº¤ã€ çš„ä¸€ç§å®ç°æ–¹å¼ã€‚

ç”šè‡³å¯ä»¥`è½»æ¾çš„é›†æˆè¿› React` [èµ„æ–™](https://juejin.cn/post/6844904095594381325)

 åŒºåˆ«

Proxy å’Œ Object.defineProperty çš„ä½¿ç”¨æ–¹æ³•çœ‹ä¼¼å¾ˆç›¸ä¼¼ï¼Œå…¶å® Proxy æ˜¯åœ¨ ã€Œæ›´é«˜ç»´åº¦ã€ ä¸Šå»æ‹¦æˆªå±æ€§çš„ä¿®æ”¹çš„ï¼Œæ€ä¹ˆç†è§£å‘¢ï¼Ÿ

Vue2 ä¸­ï¼Œå¯¹äºç»™å®šçš„ dataï¼Œå¦‚ `{ count: 1 }`ï¼Œæ˜¯éœ€è¦æ ¹æ®å…·ä½“çš„ key ä¹Ÿå°±æ˜¯ `count`ï¼Œå»å¯¹ã€Œä¿®æ”¹ data.count ã€ å’Œ ã€Œè¯»å– data.countã€è¿›è¡Œæ‹¦æˆªï¼Œä¹Ÿå°±æ˜¯

```jsx
Object.defineProperty(data, 'count', {
  // eslint-disbale-next-line
  get () {
    // nop
  },
  set () {}
})
```

å¿…é¡»é¢„å…ˆçŸ¥é“è¦æ‹¦æˆªçš„ key æ˜¯ä»€ä¹ˆï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ Vue2 é‡Œå¯¹äºå¯¹è±¡ä¸Šçš„æ–°å¢å±æ€§æ— èƒ½ä¸ºåŠ›ã€‚

è€Œ Vue3 æ‰€ä½¿ç”¨çš„ Proxyï¼Œåˆ™æ˜¯è¿™æ ·æ‹¦æˆªçš„ï¼š

```js
const p = new Proxy(data, {
  get (key) { },
  set (key, value) { }
})
```

å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æœ¬ä¸éœ€è¦å…³å¿ƒå…·ä½“çš„ keyï¼Œå®ƒå»æ‹¦æˆªçš„æ˜¯ ã€Œä¿®æ”¹ data ä¸Šçš„ä»»æ„ keyã€ å’Œ ã€Œè¯»å– data ä¸Šçš„ä»»æ„ keyã€ã€‚

æ‰€ä»¥ï¼Œä¸ç®¡æ˜¯å·²æœ‰çš„ key è¿˜æ˜¯æ–°å¢çš„ keyï¼Œéƒ½é€ƒä¸è¿‡å®ƒçš„é­”çˆªã€‚

ä½†æ˜¯ Proxy æ›´åŠ å¼ºå¤§çš„åœ°æ–¹è¿˜åœ¨äº Proxy é™¤äº† get å’Œ setï¼Œè¿˜å¯ä»¥æ‹¦æˆªæ›´å¤šçš„æ“ä½œç¬¦ã€‚

 ç®€å•çš„ä¾‹å­ğŸŒ°

å…ˆå†™ä¸€ä¸ª Vue3 å“åº”å¼çš„æœ€å°æ¡ˆä¾‹ï¼Œæœ¬æ–‡çš„ç›¸å…³æ¡ˆä¾‹éƒ½åªä¼šç”¨ `reactive` å’Œ `effect` è¿™ä¸¤ä¸ª apiã€‚å¦‚æœä½ äº†è§£è¿‡ React ä¸­çš„ `useEffect`ï¼Œç›¸ä¿¡ä½ ä¼šå¯¹è¿™ä¸ªæ¦‚å¿µç§’æ‡‚ï¼ŒVue3 çš„ `effect` ä¸è¿‡å°±æ˜¯å»æ‰äº†æ‰‹åŠ¨å£°æ˜ä¾èµ–çš„ã€Œè¿›åŒ–ç‰ˆã€çš„ `useEffect`ã€‚

React ä¸­æ‰‹åŠ¨å£°æ˜ `[data.count]` è¿™ä¸ªä¾èµ–çš„æ­¥éª¤è¢« Vue3 å†…éƒ¨ç›´æ¥åšæ‰äº†ï¼Œåœ¨ `effect` å‡½æ•°å†…éƒ¨è¯»å–åˆ° `data.count` çš„æ—¶å€™ï¼Œå®ƒå°±å·²ç»è¢«æ”¶é›†ä½œä¸ºä¾èµ–äº†ã€‚

Vue3ï¼š

```kotlin
// å“åº”å¼æ•°æ®
const data = reactive({
 count: 1
})

// è§‚æµ‹å˜åŒ–
effect(() => console.log('count changed', data.count))

// è§¦å‘ console.log('count changed', data.count) é‡æ–°æ‰§è¡Œ
data.count = 2

```

Reactï¼š

```scss
// æ•°æ®
const [data, setData] = useState({
 count: 1
})

// è§‚æµ‹å˜åŒ– éœ€è¦æ‰‹åŠ¨å£°æ˜ä¾èµ–
useEffect(() => {
 console.log('count changed', data.count)
}, [data.count])

// è§¦å‘ console.log('count changed', data.count) é‡æ–°æ‰§è¡Œ
setData({
 count: 2
})

```

ä¹Ÿå¯ä»¥æŠŠ `effect` ä¸­çš„å›è°ƒå‡½æ•°è”æƒ³åˆ°è§†å›¾çš„é‡æ–°æ¸²æŸ“ã€ watch çš„å›è°ƒå‡½æ•°ç­‰ç­‰â€¦â€¦ å®ƒä»¬æ˜¯åŒæ ·åŸºäºè¿™å¥—å“åº”å¼æœºåˆ¶çš„ã€‚

è€Œæœ¬æ–‡çš„æ ¸å¿ƒç›®çš„ï¼Œå°±æ˜¯æ¢ç©¶è¿™ä¸ªåŸºäº Proxy çš„ reactive apiï¼Œåˆ°åº•èƒ½å¼ºå¤§åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Œèƒ½ç›‘å¬åˆ°ç”¨æˆ·å¯¹äºä»€ä¹ˆç¨‹åº¦çš„ä¿®æ”¹ã€‚

 è®²è®²åŸç†

å…ˆæœ€å°åŒ–çš„è®²è§£ä¸€ä¸‹å“åº”å¼çš„åŸç†ï¼Œå…¶å®å°±æ˜¯åœ¨ Proxy ç¬¬äºŒä¸ªå‚æ•° `handler` ä¹Ÿå°±æ˜¯é™·é˜±æ“ä½œç¬¦ä¸­ï¼Œæ‹¦æˆªå„ç§å–å€¼ã€èµ‹å€¼æ“ä½œï¼Œä¾æ‰˜ `track` å’Œ `trigger` ä¸¤ä¸ªå‡½æ•°è¿›è¡Œä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°ã€‚

`track` ç”¨æ¥åœ¨è¯»å–æ—¶æ”¶é›†ä¾èµ–ã€‚

`trigger` ç”¨æ¥åœ¨æ›´æ–°æ—¶è§¦å‘ä¾èµ–ã€‚

 track

```vbnet
function track(target: object, type: TrackOpTypes, key: unknown) {
 const depsMap = targetMap.get(target);
 // æ”¶é›†ä¾èµ–æ—¶ é€šè¿‡ key å»ºç«‹ä¸€ä¸ª set
 let dep = new Set()
 targetMap.set(ITERATE_KEY, dep)
 // è¿™ä¸ª effect å¯ä»¥å…ˆç†è§£ä¸ºæ›´æ–°å‡½æ•° å­˜æ”¾åœ¨ dep é‡Œ
 dep.add(effect)
}

```

`target` æ˜¯åŸå¯¹è±¡ã€‚

`type` æ˜¯æœ¬æ¬¡æ”¶é›†çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯æ”¶é›†ä¾èµ–çš„æ—¶å€™ç”¨æ¥æ ‡è¯†æ˜¯ä»€ä¹ˆç±»å‹çš„æ“ä½œï¼Œæ¯”å¦‚ä¸Šæ–‡ä¾èµ–ä¸­çš„ç±»å‹å°±æ˜¯ `get`ï¼Œè¿™ä¸ªåç»­ä¼šè¯¦ç»†è®²è§£ã€‚

`key` æ˜¯æŒ‡æœ¬æ¬¡è®¿é—®çš„æ˜¯æ•°æ®ä¸­çš„å“ªä¸ª keyï¼Œæ¯”å¦‚ä¸Šæ–‡ä¾‹å­ä¸­æ”¶é›†ä¾èµ–çš„ key å°±æ˜¯ `count`

é¦–å…ˆå…¨å±€ä¼šå­˜åœ¨ä¸€ä¸ª `targetMap`ï¼Œå®ƒç”¨æ¥å»ºç«‹ `æ•°æ® -> ä¾èµ–` çš„æ˜ å°„ï¼Œå®ƒæ˜¯ä¸€ä¸ª WeakMap æ•°æ®ç»“æ„ã€‚

è€Œ `targetMap` é€šè¿‡æ•°æ® `target`ï¼Œå¯ä»¥è·å–åˆ° `depsMap`ï¼Œå®ƒç”¨æ¥å­˜æ”¾è¿™ä¸ªæ•°æ®å¯¹åº”çš„æ‰€æœ‰å“åº”å¼ä¾èµ–ã€‚

`depsMap` çš„æ¯ä¸€é¡¹åˆ™æ˜¯ä¸€ä¸ª Set æ•°æ®ç»“æ„ï¼Œè€Œè¿™ä¸ª Set å°±å­˜æ”¾ç€å¯¹åº” key çš„æ›´æ–°å‡½æ•°ã€‚

æ˜¯ä¸æ˜¯æœ‰ç‚¹ç»•ï¼Ÿæˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥ä¸¾ä¾‹å§ã€‚

```ini
const target = { count: 1}
const data = reactive(target)

const effection = effect(() => {
 console.log(data.count)
})

```

å¯¹äºè¿™ä¸ªä¾‹å­çš„ä¾èµ–å…³ç³»ï¼Œ

1. å…¨å±€çš„ `targetMap` æ˜¯ï¼š

```js
// targetMap: {
//  { count: 1 }: dep
// }
```

2. dep åˆ™æ˜¯

```js
// dep: {
//  count: Set { effection }
// }
```

è¿™æ ·ä¸€å±‚å±‚çš„ä¸‹å»ï¼Œå°±å¯ä»¥é€šè¿‡ `target` æ‰¾åˆ° `count` å¯¹åº”çš„æ›´æ–°å‡½æ•° `effection` äº†ã€‚

 trigger

è¿™é‡Œæ˜¯æœ€å°åŒ–çš„å®ç°ï¼Œä»…ä»…ä¸ºäº†ä¾¿äºç†è§£åŸç†ï¼Œå®é™…ä¸Šè¦å¤æ‚å¾ˆå¤šï¼Œ

å…¶å® `type` çš„ä½œç”¨å¾ˆå…³é”®ï¼Œå…ˆè®°ä½ï¼Œåé¢ä¼šè¯¦ç»†è®²ã€‚

```typescript
export function trigger (
  target: object,
  type: TriggerOpTypes,
  key?: unknown
) {
  // ç®€åŒ–æ¥è¯´ å°±æ˜¯é€šè¿‡ key æ‰¾åˆ°æ‰€æœ‰æ›´æ–°å‡½æ•° ä¾æ¬¡æ‰§è¡Œ
  const dep = targetMap.get(target)
  dep.get(key).forEach(effect => effect())
}
```

vue3 çš„å“åº”å¼åº“æ˜¯ç‹¬ç«‹å‡ºæ¥çš„ï¼Œå®ƒå¯ä»¥å¾ˆæ–¹ä¾¿çš„é›†æˆè¿› Reactï¼Œ ä½œä¸º React çš„çŠ¶æ€ç®¡ç†åº“ä½¿ç”¨ï¼

 ä½¿ç”¨ç¤ºèŒƒ

å®šä¹‰ store

```typescript
// store.ts
import { reactive, computed, effect } from '@vue/reactivity'

export const state = reactive({
  count: 0
})

const plusOne = computed(() => state.count + 1)

effect(() => {
  console.log('plusOne changed: ', plusOne)
})

const add = () => (state.count += 1)

export const mutations = {
  // mutation
  add
}

export const store = {
  state,
  computed: {
    plusOne
  }
}

export type Store = typeof store;
```

æ¶ˆè´¹ä½¿ç”¨

```tsx
// Index.tsx
import { Provider, useStore } from 'rxv'
import { mutations, store, Store } from './store.ts'
function Count () {
  const countState = useStore((store: Store) => {
    const { state, computed } = store
    const { count } = state
    const { plusOne } = computed

    return {
      count,
      plusOne
    }
  })

  return (
 <Card hoverable style={{ marginBottom: 24 }}>
 <h1>è®¡æ•°å™¨</h1>
 <div className="chunk">
 <div className="chunk">storeä¸­çš„countç°åœ¨æ˜¯ {countState.count}</div>
 <div className="chunk">computedå€¼ä¸­çš„plusOneç°åœ¨æ˜¯ {countState.plusOne.value}</div>
 <Button onClick={mutations.add}>add</Button>
 </div>
 </Card>
  )
}

export default () => {
  return (
 <Provider value={store}>
 <Count />
 </Provider>
  )
}
```

å¯ä»¥çœ‹å‡ºï¼Œstoreçš„å®šä¹‰åªç”¨åˆ°äº†@vue/reactivityï¼Œè€Œrxvåªæ˜¯åœ¨ç»„ä»¶ä¸­åšäº†ä¸€å±‚æ¡¥æ¥ï¼Œè¿é€šäº†Vue3å’ŒReactï¼Œæ­£å¦‚å®ƒåå­—çš„å«ä¹‰ï¼šReact x Vueã€‚

 å¦‚ä½•å®ç°

åªè¦effectèƒ½æ¥å…¥åˆ°Reactç³»ç»Ÿä¸­ï¼Œé‚£ä¹ˆå…¶ä»–çš„apiéƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯å»æ”¶é›†effectçš„ä¾èµ–ï¼Œå»é€šçŸ¥effectè§¦å‘æ›´æ–°ã€‚

effectæ¥å—çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸”effectè¿˜æ”¯æŒé€šè¿‡ä¼ å…¥scheduleå‚æ•°æ¥è‡ªå®šä¹‰ä¾èµ–æ›´æ–°çš„æ—¶å€™éœ€è¦è§¦å‘ä»€ä¹ˆå‡½æ•°ï¼Œ

è€Œrxvçš„æ ¸å¿ƒapi: useStoreæ¥å—çš„ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°selectorï¼Œå®ƒä¼šè®©ç”¨æˆ·è‡ªå·±é€‰æ‹©åœ¨ç»„ä»¶ä¸­éœ€è¦è®¿é—®çš„æ•°æ®ã€‚

æŠŠselectoråŒ…è£…åœ¨effectä¸­æ‰§è¡Œï¼Œå»æ”¶é›†ä¾èµ–ã€‚

æŒ‡å®šä¾èµ–å‘ç”Ÿæ›´æ–°æ—¶ï¼Œéœ€è¦è°ƒç”¨çš„å‡½æ•°æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨useStoreçš„è¿™ä¸ªç»„ä»¶çš„forceUpdateå¼ºåˆ¶æ¸²æŸ“å‡½æ•°ã€‚

ç®€å•çš„çœ‹ä¸€ä¸‹æ ¸å¿ƒå®ç°

share.ts

```typescript
export const useForceUpdate = () => {
  const [, forceUpdate] = useReducer(s => s + 1, 0)
  return forceUpdate
}

export const useEffection = (...effectArgs: Parameters<typeof effect>) => {
  // ç”¨ä¸€ä¸ªrefå­˜å‚¨effection
  // effectå‡½æ•°åªéœ€è¦åˆå§‹åŒ–æ‰§è¡Œä¸€é
  const effectionRef = useRef<ReactiveEffect>()
  if (!effectionRef.current) {
    effectionRef.current = effect(...effectArgs)
  }

  // å¸è½½ç»„ä»¶åå–æ¶ˆeffect
  const stopEffect = () => {
    stop(effectionRef.current!)
  }
  useEffect(() => stopEffect, [])

  return effectionRef.current
}
```

æ ¸å¿ƒé€»è¾‘åœ¨æ­¤

```typescript
import React, { useContext } from 'react'
import { useForceUpdate, useEffection } from './share'

type Selector<T, S> = (store: T) => S;

const StoreContext = React.createContext<any>(null)

const useStoreContext = () => {
  const contextValue = useContext(StoreContext)
  if (!contextValue) {
    throw new Error(
      'could not find store context value; please ensure the component is wrapped in a <Provider>'
    )
  }
  return contextValue
}

/**
åœ¨ç»„ä»¶ä¸­è¯»å–å…¨å±€çŠ¶æ€
éœ€è¦é€šè¿‡ä¼ å…¥çš„å‡½æ•°æ”¶é›†ä¾èµ–
 */
export const useStore = <T, S>(selector: Selector<T, S>): S => {
  const forceUpdate = useForceUpdate()
  const store = useStoreContext()

  const effection = useEffection(() => selector(store), {
    scheduler: job => {
      if (job() === undefined) return
      forceUpdate()
    },
    lazy: true
  })

  const value = effection()
  return value
}

export const Provider = StoreContext.Provider
```

å‚è€ƒæ–‡æ¡£ï¼š

* [èµ„æ–™](https://github.com/sl1673495/react-composition-api)
* [èµ„æ–™](https://juejin.cn/post/6844904054192078855)

## data  {#p1-data}

`vue` å®ä¾‹çš„æ—¶å€™å®šä¹‰`data`å±æ€§æ—¢å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°

```js
const app = new Vue({
  el: '#app',
  // å¯¹è±¡æ ¼å¼
  data: {
    foo: 'foo'
  }
  // å‡½æ•°æ ¼å¼
  // data () {
  //   return {
  //     foo: 'foo'
  //   }
  // }
})
```

ç»„ä»¶ä¸­å®šä¹‰dataå±æ€§ï¼Œåªèƒ½æ˜¯ä¸€ä¸ªå‡½æ•°

å¦‚æœä¸ºç»„ä»¶dataç›´æ¥å®šä¹‰ä¸ºä¸€ä¸ªå¯¹è±¡

```js
Vue.component('component1', {
  template: '<div>ç»„ä»¶</div>',
  data: {
    foo: 'foo'
  }
})
```

åˆ™ä¼šå¾—åˆ°è­¦å‘Šä¿¡æ¯

è­¦å‘Šè¯´æ˜ï¼šè¿”å›çš„dataåº”è¯¥æ˜¯ä¸€ä¸ªå‡½æ•°åœ¨æ¯ä¸€ä¸ªç»„ä»¶å®ä¾‹ä¸­

**ç»„ä»¶dataå®šä¹‰å‡½æ•°ä¸å¯¹è±¡çš„åŒºåˆ«**

ä¸Šé¢è®²åˆ°ç»„ä»¶dataå¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æ€è€ƒè¿‡è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

åœ¨æˆ‘ä»¬å®šä¹‰å¥½ä¸€ä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œvueæœ€ç»ˆéƒ½ä¼šé€šè¿‡Vue.extend()æ„æˆç»„ä»¶å®ä¾‹

è¿™é‡Œæˆ‘ä»¬æ¨¡ä»¿ç»„ä»¶æ„é€ å‡½æ•°ï¼Œå®šä¹‰dataå±æ€§ï¼Œé‡‡ç”¨å¯¹è±¡çš„å½¢å¼

```js
function Component () {

}

Component.prototype.data = {
  count: 0
}
```

åˆ›å»ºä¸¤ä¸ªç»„ä»¶å®ä¾‹

```js
const componentA = new Component()
const componentB = new Component()
```

äº§ç”Ÿè¿™æ ·çš„åŸå› è¿™æ˜¯ä¸¤è€…å…±ç”¨äº†åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼ŒcomponentAä¿®æ”¹çš„å†…å®¹ï¼ŒåŒæ ·å¯¹componentBäº§ç”Ÿäº†å½±å“

å¦‚æœæˆ‘ä»¬é‡‡ç”¨å‡½æ•°çš„å½¢å¼ï¼Œåˆ™ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼ˆå‡½æ•°è¿”å›çš„å¯¹è±¡å†…å­˜åœ°å€å¹¶ä¸ç›¸åŒï¼‰

```js
function Component () {
  this.data = this.data()
}

Component.prototype.data = function () {
  return {
    count: 0
  }
}
```

ä¿®æ”¹componentAç»„ä»¶dataå±æ€§çš„å€¼ï¼ŒcomponentBä¸­çš„å€¼ä¸å—å½±å“

```js
console.log(componentB.data.count) // 0
componentA.data.count = 1
console.log(componentB.data.count) // 0
```

vueç»„ä»¶å¯èƒ½ä¼šæœ‰å¾ˆå¤šä¸ªå®ä¾‹ï¼Œé‡‡ç”¨å‡½æ•°è¿”å›ä¸€ä¸ªå…¨æ–°dataå½¢å¼ï¼Œä½¿æ¯ä¸ªå®ä¾‹å¯¹è±¡çš„æ•°æ®ä¸ä¼šå—åˆ°å…¶ä»–å®ä¾‹å¯¹è±¡æ•°æ®çš„æ±¡æŸ“

**åŸç†åˆ†æ**

é¦–å…ˆå¯ä»¥çœ‹çœ‹vueåˆå§‹åŒ–dataçš„ä»£ç ï¼Œdataçš„å®šä¹‰å¯ä»¥æ˜¯å‡½æ•°ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡

æºç ä½ç½®ï¼š`/vue-dev/src/core/instance/state.js`

```ts
function initData (vm: Component) {
  let data = vm.$options.data
  data = vm._data = typeof data === 'function'
    ? getData(data, vm)
    : data || {}
  // ...
}
```

`data`æ—¢èƒ½æ˜¯`object`ä¹Ÿèƒ½æ˜¯`function`ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºç°ä¸Šæ–‡è­¦å‘Šå‘¢ï¼Ÿ

åˆ«æ€¥ï¼Œç»§ç»­çœ‹ä¸‹æ–‡

ç»„ä»¶åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œä¼šè¿›è¡Œé€‰é¡¹çš„åˆå¹¶

æºç ä½ç½®ï¼š`/vue-dev/src/core/util/options.js`

è‡ªå®šä¹‰ç»„ä»¶ä¼šè¿›å…¥`mergeOptions`è¿›è¡Œé€‰é¡¹åˆå¹¶

```ts
Vue.prototype._init = function (options?: object) {
  // ...
  // merge options
  if (options && options._isComponent) {
    // optimize internal component instantiation
    // since dynamic options merging is pretty slow, and none of the
    // internal component options needs special treatment.
    initInternalComponent(vm, options)
  } else {
    vm.$options = mergeOptions(
      resolveConstructorOptions(vm.constructor),
      options || {},
      vm
    )
  }
  // ...
}
```

å®šä¹‰dataä¼šè¿›è¡Œæ•°æ®æ ¡éªŒ

æºç ä½ç½®ï¼š`/vue-dev/src/core/instance/init.js`

è¿™æ—¶å€™`vm`å®ä¾‹ä¸º`undefined`ï¼Œè¿›å…¥ifåˆ¤æ–­ï¼Œè‹¥`data`ç±»å‹ä¸æ˜¯`function`ï¼Œåˆ™å‡ºç°è­¦å‘Šæç¤º

```tsx
strats.data = function (
  parentVal: any,
  childVal: any,
  vm?: Component
): () => any {
  if (!vm) {
    if (childVal && typeof childVal !== 'function') {
      process.env.NODE_ENV !== 'production' &&
 warn(
   'The "data" option should be a function ' +
 'that returns a per-instance value in component ' +
 'definitions.',
   vm
 )

      return parentVal
    }
    return mergeDataOrFn(parentVal, childVal)
  }
  return mergeDataOrFn(parentVal, childVal, vm)
}
```

**ç»“è®º**

* æ ¹å®ä¾‹å¯¹è±¡`data`å¯ä»¥æ˜¯å¯¹è±¡ä¹Ÿå¯ä»¥æ˜¯å‡½æ•°ï¼ˆæ ¹å®ä¾‹æ˜¯å•ä¾‹ï¼‰ï¼Œä¸ä¼šäº§ç”Ÿæ•°æ®æ±¡æŸ“æƒ…å†µ
* ç»„ä»¶å®ä¾‹å¯¹è±¡`data`å¿…é¡»ä¸ºå‡½æ•°ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢å¤šä¸ªç»„ä»¶å®ä¾‹å¯¹è±¡ä¹‹é—´å…±ç”¨ä¸€ä¸ª`data`ï¼Œäº§ç”Ÿæ•°æ®æ±¡æŸ“ã€‚é‡‡ç”¨å‡½æ•°çš„å½¢å¼ï¼Œ`initData`æ—¶ä¼šå°†å…¶ä½œä¸ºå·¥å‚å‡½æ•°éƒ½ä¼šè¿”å›å…¨æ–°`data`å¯¹è±¡

**å…³é”®è¯**ï¼švueæ›´æ”¹dataå±æ€§

**ç›´æ¥æ·»åŠ å±æ€§çš„é—®é¢˜**

æˆ‘ä»¬ä»ä¸€ä¸ªä¾‹å­å¼€å§‹

å®šä¹‰ä¸€ä¸ª`p`æ ‡ç­¾ï¼Œé€šè¿‡`v-for`æŒ‡ä»¤è¿›è¡Œéå†

ç„¶åç»™`botton`æ ‡ç­¾ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œæˆ‘ä»¬é¢„æœŸç‚¹å‡»æŒ‰é’®æ—¶ï¼Œæ•°æ®æ–°å¢ä¸€ä¸ªå±æ€§ï¼Œç•Œé¢ä¹Ÿ æ–°å¢ä¸€è¡Œ

```vue

<template>
 <p v-for="(value,key) in item" :key="key">
 {{ value }}
 </p>
 <button @click="addProperty">åŠ¨æ€æ·»åŠ æ–°å±æ€§</button>
</template>
```

å®ä¾‹åŒ–ä¸€ä¸ª`vue`å®ä¾‹ï¼Œå®šä¹‰`data`å±æ€§å’Œ`methods`æ–¹æ³•

```js
const app = new Vue({
  el: '#app',
  data: () => ({
    // 'æ—§å±æ€§'
  }
  ),
  methods: {
    addProperty () {
      this.items.newProperty = 'æ–°å±æ€§' // ä¸ºitemsæ·»åŠ æ–°å±æ€§
      console.log(this.items) // è¾“å‡ºå¸¦æœ‰newPropertyçš„items
    }
  }
})
```

ç‚¹å‡»æŒ‰é’®ï¼Œå‘ç°ç»“æœä¸åŠé¢„æœŸï¼Œæ•°æ®è™½ç„¶æ›´æ–°äº†ï¼ˆconsoleæ‰“å°å‡ºäº†æ–°å±æ€§ï¼‰ï¼Œä½†é¡µé¢å¹¶æ²¡æœ‰æ›´æ–°

**åŸç†åˆ†æ**

ä¸ºä»€ä¹ˆäº§ç”Ÿä¸Šé¢çš„æƒ…å†µå‘¢ï¼Ÿ

ä¸‹é¢æ¥åˆ†æä¸€ä¸‹

`vue2`æ˜¯ç”¨è¿‡`Object.defineProperty`å®ç°æ•°æ®å“åº”å¼

```js
const obj = {}
Object.defineProperty(obj, 'foo', {
  get () {
    console.log(`get foo:${val}`)
    return val
  },
  set (newVal) {
    if (newVal !== val) {
      console.log(`set foo:${newVal}`)
      val = newVal
    }
  }
})
```

å½“æˆ‘ä»¬è®¿é—®`foo`å±æ€§æˆ–è€…è®¾ç½®`foo`å€¼çš„æ—¶å€™éƒ½èƒ½å¤Ÿè§¦å‘`setterä¸getter`

```js
obj.foo
obj.foo = 'new'
```

ä½†æ˜¯æˆ‘ä»¬ä¸º`obj`æ·»åŠ æ–°å±æ€§çš„æ—¶å€™ï¼Œå´æ— æ³•è§¦å‘äº‹ä»¶å±æ€§çš„æ‹¦æˆª

```js
obj.bar = 'æ–°å±æ€§'
```

åŸå› æ˜¯ä¸€å¼€å§‹`obj`çš„`foo`å±æ€§è¢«è®¾æˆäº†å“åº”å¼æ•°æ®ï¼Œè€Œ`bar`æ˜¯åé¢æ–°å¢çš„å±æ€§ï¼Œå¹¶æ²¡æœ‰é€šè¿‡`Object.defineProperty`è®¾ç½®æˆå“åº”å¼æ•°æ®

**è§£å†³æ–¹æ¡ˆ**

`Vue` ä¸å…è®¸åœ¨å·²ç»åˆ›å»ºçš„å®ä¾‹ä¸ŠåŠ¨æ€æ·»åŠ æ–°çš„å“åº”å¼å±æ€§

è‹¥æƒ³å®ç°æ•°æ®ä¸è§†å›¾åŒæ­¥æ›´æ–°ï¼Œå¯é‡‡å–ä¸‹é¢ä¸‰ç§è§£å†³æ–¹æ¡ˆï¼š

* `Vue.set()`
* `Object.assign()`
* `$forcecUpdated()`

**`Vue.set()`**

`Vue.set( target, propertyName/index, value )`

å‚æ•°

* `{Object | Array} target`
* `{string | number} propertyName/index`
* `{any} value`

è¿”å›å€¼ï¼šè®¾ç½®çš„å€¼

é€šè¿‡`Vue.set`å‘å“åº”å¼å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ª`property`ï¼Œå¹¶ç¡®ä¿è¿™ä¸ªæ–° `property` åŒæ ·æ˜¯å“åº”å¼çš„ï¼Œä¸”è§¦å‘è§†å›¾æ›´æ–°

å…³äº`Vue.set`æºç ï¼ˆçœç•¥äº†å¾ˆå¤šä¸æœ¬èŠ‚ä¸ç›¸å…³çš„ä»£ç ï¼‰

æºç ä½ç½®ï¼š`src\core\observer\index.js`

```ts
function set (target: Array<any> | object, key: any, val: any): any {
  // ...
  defineReactive(ob.value, key, val)
  ob.dep.notify()
  return val
}
```

è¿™é‡Œæ— éå†æ¬¡è°ƒç”¨ `defineReactive` æ–¹æ³•ï¼Œå®ç°æ–°å¢å±æ€§çš„å“åº”å¼

å…³äº `defineReactive` æ–¹æ³•ï¼Œå†…éƒ¨è¿˜æ˜¯é€šè¿‡ `Object.defineProperty` å®ç°å±æ€§æ‹¦æˆª

```js
function defineReactive (obj, key, val) {
  Object.defineProperty(obj, key, {
    get () {
      console.log(`get ${key}:${val}`)
      return val
    },
    set (newVal) {
      if (newVal !== val) {
        console.log(`set ${key}:${newVal}`)
        val = newVal
      }
    }
  })
}
```

**`Object.assign()`**

ç›´æ¥ä½¿ç”¨Object.assign()æ·»åŠ åˆ°å¯¹è±¡çš„æ–°å±æ€§ä¸ä¼šè§¦å‘æ›´æ–°

åº”åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œåˆå¹¶åŸå¯¹è±¡å’Œæ··å…¥å¯¹è±¡çš„å±æ€§

```js
this.someObject = Object.assign({}, this.someObject, { newProperty1: 1, newProperty2: 2 })
```

**`$forceUpdate`**

å¦‚æœä½ å‘ç°ä½ è‡ªå·±éœ€è¦åœ¨ Vue ä¸­åšä¸€æ¬¡å¼ºåˆ¶æ›´æ–°ï¼Œ99.9% çš„æƒ…å†µï¼Œæ˜¯ä½ åœ¨æŸä¸ªåœ°æ–¹åšé”™äº†äº‹

`$forceUpdate` è¿«ä½¿ Vue å®ä¾‹é‡æ–°æ¸²æŸ“

PSï¼šä»…ä»…å½±å“å®ä¾‹æœ¬èº«å’Œæ’å…¥æ’æ§½å†…å®¹çš„å­ç»„ä»¶ï¼Œè€Œä¸æ˜¯æ‰€æœ‰å­ç»„ä»¶ã€‚

**å°ç»“**

å¦‚æœä¸ºå¯¹è±¡æ·»åŠ å°‘é‡çš„æ–°å±æ€§ï¼Œå¯ä»¥ç›´æ¥é‡‡ç”¨`Vue.set()`

å¦‚æœéœ€è¦ä¸ºæ–°å¯¹è±¡æ·»åŠ å¤§é‡çš„æ–°å±æ€§ï¼Œåˆ™é€šè¿‡`Object.assign()`åˆ›å»ºæ–°å¯¹è±¡

å¦‚æœä½ å®åœ¨ä¸çŸ¥é“æ€ä¹ˆæ“ä½œæ—¶ï¼Œå¯é‡‡å–`$forceUpdate()`è¿›è¡Œå¼ºåˆ¶åˆ·æ–° (ä¸å»ºè®®)

## ref å’Œ reactive æœ‰ä½•åŒºåˆ«å— {#p1-ref-reactive}

åœ¨ Vue 3 ä¸­ï¼Œ`ref` å’Œ `reactive` æ˜¯åˆ›å»ºå“åº”å¼æ•°æ®çš„ä¸¤ç§ä¸åŒæ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ˜¯ Vue çš„å“åº”å¼ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä½†åœ¨ä½¿ç”¨æ–¹å¼å’Œé€‚ç”¨åœºæ™¯ä¸Šæœ‰ä¸€äº›åŒºåˆ«ã€‚ä¸‹é¢æ˜¯ `ref` å’Œ `reactive` çš„ä¸»è¦åŒºåˆ«ï¼š

 `ref`

* **ç”¨æ³•**ï¼š`ref` ç”¨äºåˆ›å»ºä¸€ä¸ªå“åº”å¼çš„å¼•ç”¨ç±»å‹æ•°æ®ã€‚å½“ä½ éœ€è¦ä½¿åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆä¾‹å¦‚ï¼šstring, number, booleanï¼‰å˜å¾—å“åº”å¼æ—¶ï¼Œ`ref` æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚
* **è¿”å›å€¼**ï¼š`ref` è¿”å›ä¸€ä¸ªåŒ…å« `value` å±æ€§çš„å¯¹è±¡ã€‚ä½ éœ€è¦é€šè¿‡ `.value` å±æ€§æ¥è®¿é—®æˆ–ä¿®æ”¹å…¶å†…éƒ¨å€¼ã€‚
* **é€‚ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¹Ÿå¯ä»¥ç”¨äºå¯¹è±¡å’Œæ•°ç»„ï¼Œä½†ä¸»è¦æ˜¯ä¸ºäº†åŸºæœ¬æ•°æ®ç±»å‹è®¾è®¡çš„ã€‚

```javascript
import { ref } from 'vue'

const count = ref(0)
console.log(count.value) // è®¿é—®å€¼
count.value++ // ä¿®æ”¹å€¼
```

 `reactive`

* **ç”¨æ³•**ï¼š`reactive` ç”¨äºåˆ›å»ºä¸€ä¸ªå“åº”å¼çš„å¤æ‚ç±»å‹æ•°æ®ï¼Œå¦‚å¯¹è±¡æˆ–æ•°ç»„ã€‚
* **è¿”å›å€¼**ï¼šç›´æ¥è¿”å›åŸå§‹å¯¹è±¡çš„å“åº”å¼ä»£ç†ï¼Œä¸éœ€è¦é€šè¿‡ `.value` å±æ€§æ¥è®¿é—®æˆ–ä¿®æ”¹ã€‚
* **é€‚ç”¨åœºæ™¯**ï¼šæ˜¯ä¸ºäº†ä½¿å¯¹è±¡æˆ–æ•°ç»„è¿™æ ·çš„å¼•ç”¨æ•°æ®ç±»å‹å˜å¾—å“åº”å¼è€Œè®¾è®¡çš„ã€‚

```javascript
import { reactive } from 'vue'

const state = reactive({ count: 0 })
console.log(state.count) // è®¿é—®å€¼
state.count++ // ä¿®æ”¹å€¼
```

 ä¸»è¦åŒºåˆ«

1. **æ•°æ®ç±»å‹**ï¼š`ref` ä¸»è¦ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨äºå¯¹è±¡å’Œæ•°ç»„ï¼›`reactive` é€‚ç”¨äºå¯¹è±¡æˆ–æ•°ç»„ç­‰å¼•ç”¨æ•°æ®ç±»å‹ã€‚
2. **è¿”å›å€¼**ï¼š`ref` è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«ä¸€ä¸ª `value` å±æ€§ï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦é€šè¿‡ `.value` æ¥è·å–æˆ–è®¾ç½®å€¼ï¼›è€Œ `reactive` è¿”å›çš„æ˜¯å¯¹è±¡æˆ–æ•°ç»„çš„å“åº”å¼ä»£ç†ï¼Œå¯ä»¥ç›´æ¥æ“ä½œã€‚
3. **æ¨¡æ¿ä¸­ä½¿ç”¨**ï¼šåœ¨æ¨¡æ¿ä¸­ä½¿ç”¨æ—¶ï¼Œ`ref` åˆ›å»ºçš„å“åº”å¼æ•°æ®è®¿é—®æ—¶ä¸éœ€è¦ `.value`ï¼ŒVue æ¨¡æ¿ä¼šè‡ªåŠ¨è§£åŒ…ï¼›`reactive` å¯¹è±¡åœ¨æ¨¡æ¿ä¸­çš„è¡Œä¸ºä¸æ™®é€šå¯¹è±¡ç›¸åŒã€‚

 ä½¿ç”¨å»ºè®®

* å½“ä½ å¤„ç†åŸºæœ¬æ•°æ®ç±»å‹æ—¶ï¼Œä½¿ç”¨ `ref`ï¼›
* å½“ä½ éœ€è¦ç®¡ç†ä¸€ä¸ªå¤æ‚çš„æ•°æ®ç»“æ„ï¼ˆå¦‚å¯¹è±¡æˆ–æ•°ç»„ï¼‰ï¼Œä½¿ç”¨ `reactive` ä»¥ä¿æŒä»£ç çš„ç®€æ´å’Œç›´è§‚ã€‚

åœ¨ Vue 3 çš„å“åº”å¼ç³»ç»Ÿä¸­ï¼Œå¤„ç†æ·±å±‚åµŒå¥—çš„æ•°æ®æ—¶ï¼Œ`ref` å’Œ `reactive` åœ¨è¡Œä¸ºä¸Šæœ‰ä¸€äº›ç»†å¾®ä½†é‡è¦çš„åŒºåˆ«ï¼Œç‰¹åˆ«æ˜¯å½“æ¶‰åŠåˆ°å¯¹è±¡ã€æ•°ç»„ä»¥åŠ JavaScript å†…ç½®çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ Map å’Œ Setï¼‰æ—¶ã€‚è¿™äº›åŒºåˆ«ä¸»è¦ä½“ç°åœ¨å¦‚ä½•ä½¿åµŒå¥—çš„æ•°æ®æˆä¸ºå“åº”å¼çš„ï¼Œä»¥åŠå¦‚ä½•ç»´æŠ¤è¿™äº›å“åº”æ€§ã€‚

 å¤„ç†æ·±å±‚åµŒå¥—çš„æ•°æ®

æ— è®ºæ˜¯ä½¿ç”¨ `ref` è¿˜æ˜¯ `reactive`ï¼ŒVue ä¼šå°è¯•ä½¿ç»™å®šçš„æ•°æ®ç»“æ„åŠå…¶åµŒå¥—çš„æ‰€æœ‰å­ç»“æ„å˜æˆå“åº”å¼çš„ã€‚ä½†æ˜¯ï¼Œå…·ä½“çš„å®ç°æœºåˆ¶æœ‰æ‰€ä¸åŒã€‚

 `reactive`

* `reactive` å¯¹è±¡é»˜è®¤æ·±åº¦å“åº”å¼ã€‚å½“ä½ ä½¿ç”¨ `reactive` ä½¿ä¸€ä¸ªå¯¹è±¡å˜æˆå“åº”å¼æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰åµŒå¥—å¯¹è±¡å’Œæ•°ç»„ä¹Ÿä¼šè‡ªåŠ¨å˜æˆå“åº”å¼çš„ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨ä»»æ„æ·±åº¦çš„åµŒå¥—æ•°æ®ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œå¹¶ä¸”è¿™äº›ä¿®æ”¹å°†ä¼šè§¦å‘è§†å›¾æ›´æ–°ã€‚
* å¯¹äº JavaScript çš„å†…ç½®æ•°æ®ç»“æ„ï¼Œå¦‚ Map å’Œ Setï¼ŒVue 3 ä¹Ÿæä¾›äº†å“åº”å¼æ”¯æŒï¼Œä½†å®ƒä»¬å¿…é¡»é€šè¿‡ `reactive` æ–¹æ³•æ¥åˆ›å»ºæˆ–è½¬æ¢ä¸ºå“åº”å¼çš„ã€‚

```javascript
const state = reactive({
  nested: {
    count: 0
  },
  numbers: [1, 2, 3],
  map: new Map()
})

state.nested.count++ // è§¦å‘è§†å›¾æ›´æ–°
state.numbers.push(4) // è§¦å‘è§†å›¾æ›´æ–°
state.map.set('key', 'value') // è§¦å‘è§†å›¾æ›´æ–°
```

 `ref`

* ä½¿ç”¨ `ref` åˆ›å»ºå“åº”å¼æ•°æ®æ—¶ï¼Œå¦‚æœ `ref` è¢«èµ‹å€¼ä¸ºä¸€ä¸ªå¯¹è±¡æˆ–æ•°ç»„ï¼ŒVue ä¼šå°†è¯¥å¯¹è±¡æˆ–æ•°ç»„å†…éƒ¨è½¬æ¢ä¸ºæ·±åº¦å“åº”å¼ã€‚ç„¶è€Œï¼Œè¿™ç§è½¬æ¢ä»…å‘ç”Ÿåœ¨èµ‹å€¼æ“ä½œæ—¶ï¼Œå¦‚æœåç»­å¯¹è¯¥å¯¹è±¡æˆ–æ•°ç»„è¿›è¡Œå†åµŒå¥—ï¼Œæ–°å¢çš„åµŒå¥—ä¸ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå“åº”å¼ã€‚
* å¯¹äºå†…ç½®æ•°æ®ç»“æ„å¦‚ Map å’Œ Setï¼Œ`ref` å¯ä»¥å­˜å‚¨å®ƒä»¬ï¼Œä½†ä¸ä¼šä½¿å®ƒä»¬æˆ–å…¶å†…å®¹å˜æˆå“åº”å¼çš„ã€‚å¦‚æœä½ éœ€è¦åœ¨æ¨¡æ¿ä¸­ç›´æ¥ç»‘å®šè¿™äº›æ•°æ®ç»“æ„çš„å“åº”å¼å˜åŒ–ï¼Œä½¿ç”¨ `reactive` ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

```javascript
const nestedObj = ref({
  nested: {
    count: 0
  }
})

nestedObj.value.nested.count++ // è§¦å‘è§†å›¾æ›´æ–°

const map = ref(new Map())
map.value.set('key', 'value') // ä¸ä¼šè§¦å‘è§†å›¾æ›´æ–°ï¼Œé™¤éé‡æ–°èµ‹å€¼ç»™ map.value
```

æ€»ç»“

å½“å¤„ç†æ·±å±‚åµŒå¥—çš„å¯¹è±¡ã€æ•°ç»„æˆ–å†…ç½®æ•°æ®ç»“æ„æ—¶ï¼š

* `reactive` é»˜è®¤æä¾›æ·±åº¦å“åº”å¼ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ Mapã€Set ç­‰å†…ç½®æ•°æ®ç»“æ„å˜ä¸ºå“åº”å¼ã€‚
* `ref` åœ¨èµ‹å€¼å¯¹è±¡æˆ–æ•°ç»„æ—¶è‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºå“åº”å¼ï¼Œä½†ä¸é€‚ç”¨äº Map æˆ– Set ç­‰å†…ç½®æ•°æ®ç»“æ„çš„æ·±åº¦å“åº”ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹äºå¤æ‚æˆ–æ·±å±‚åµŒå¥—çš„æ•°æ®ç»“æ„ï¼Œ`reactive` æ›´åŠ é€‚åˆã€‚å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹æˆ–ä¸å¤ªå¤æ‚çš„åµŒå¥—æ•°æ®ï¼Œ`ref` å¯ä»¥æä¾›æ–¹ä¾¿çš„å“åº”å¼è½¬æ¢ã€‚

## computed å’Œ watch çš„åŒºåˆ« {#p0-computed-watch}

1. æ”¯æŒç¼“å­˜ï¼Œåªæœ‰ä¾èµ–æ•°æ®å‘ç”Ÿæ”¹å˜ï¼Œæ‰ä¼šé‡æ–°è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—å±æ€§å¯ç”¨äºå¿«é€Ÿè®¡ç®—è§†å›¾ï¼ˆViewï¼‰ä¸­æ˜¾ç¤ºçš„å±æ€§ã€‚è¿™äº›è®¡ç®—å°†è¢«ç¼“å­˜ï¼Œå¹¶ä¸”åªåœ¨éœ€è¦æ—¶æ›´æ–°ã€‚computedæ˜¯è®¡ç®—å±æ€§çš„; å®ƒä¼šæ ¹æ®æ‰€ä¾èµ–çš„æ•°æ®åŠ¨æ€æ˜¾ç¤ºæ–°çš„è®¡ç®—ç»“æœ, è¯¥è®¡ç®—ç»“æœä¼šè¢«ç¼“å­˜èµ·æ¥ã€‚computedçš„å€¼åœ¨getteræ‰§è¡Œåæ˜¯ä¼šè¢«ç¼“å­˜çš„ã€‚å¦‚æœæ‰€ä¾èµ–çš„æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶å€™, å°±ä¼šé‡æ–°è°ƒç”¨getteræ¥è®¡ç®—æœ€æ–°çš„ç»“æœã€‚

2. ä¸æ”¯æŒå¼‚æ­¥ï¼Œå½“computedå†…æœ‰å¼‚æ­¥æ“ä½œæ—¶æ— æ•ˆï¼Œæ— æ³•ç›‘å¬æ•°æ®çš„å˜åŒ–

3. computed å±æ€§å€¼ä¼šé»˜è®¤èµ°ç¼“å­˜ï¼Œè®¡ç®—å±æ€§æ˜¯åŸºäºå®ƒä»¬çš„å“åº”å¼ä¾èµ–è¿›è¡Œç¼“å­˜çš„ï¼Œä¹Ÿå°±æ˜¯åŸºäºdataä¸­å£°æ˜è¿‡æˆ–è€…çˆ¶ç»„ä»¶ä¼ é€’çš„propsä¸­çš„æ•°æ®é€šè¿‡è®¡ç®—å¾—åˆ°çš„å€¼

4. å¦‚æœä¸€ä¸ªå±æ€§æ˜¯ç”±å…¶ä»–å±æ€§è®¡ç®—è€Œæ¥çš„ï¼Œè¿™ä¸ªå±æ€§ä¾èµ–å…¶ä»–å±æ€§ï¼Œæ˜¯ä¸€ä¸ªå¤šå¯¹ä¸€æˆ–è€…ä¸€å¯¹ä¸€ï¼Œä¸€èˆ¬ç”¨computed

5. å¦‚æœcomputedå±æ€§å±æ€§å€¼æ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆé»˜è®¤ä¼šèµ°getæ–¹æ³•ï¼›å‡½æ•°çš„è¿”å›å€¼å°±æ˜¯å±æ€§çš„å±æ€§å€¼ï¼›åœ¨computedä¸­çš„ï¼Œå±æ€§éƒ½æœ‰ä¸€ä¸ªgetå’Œä¸€ä¸ªsetæ–¹æ³•ï¼Œå½“æ•°æ®å˜åŒ–æ—¶ï¼Œè°ƒç”¨setæ–¹æ³•ã€‚

6. é€‚ç”¨äºä¸€äº›é‡å¤ä½¿ç”¨æ•°æ®æˆ–å¤æ‚åŠè´¹æ—¶çš„è¿ç®—ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ”¾å…¥computedä¸­è¿›è¡Œè®¡ç®—, ç„¶åä¼šåœ¨computedä¸­ç¼“å­˜èµ·æ¥, ä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥è·å–äº†ã€‚

7. å¦‚æœæˆ‘ä»¬éœ€è¦çš„æ•°æ®ä¾èµ–äºå…¶ä»–çš„æ•°æ®çš„è¯, æˆ‘ä»¬å¯ä»¥æŠŠè¯¥æ•°æ®è®¾è®¡ä¸ºcomputedä¸­ã€‚

8. computed æ˜¯åŸºäºå“åº”æ€§ä¾èµ–æ¥è¿›è¡Œç¼“å­˜çš„ã€‚åªæœ‰åœ¨å“åº”å¼ä¾èµ–å‘ç”Ÿæ”¹å˜æ—¶å®ƒä»¬æ‰ä¼šé‡æ–°æ±‚å€¼, ä¹Ÿå°±æ˜¯è¯´, å½“msgå±æ€§å€¼æ²¡æœ‰å‘ç”Ÿæ”¹å˜æ—¶, å¤šæ¬¡è®¿é—® reversedMsg è®¡ç®—å±æ€§ä¼šç«‹å³è¿”å›ä¹‹å‰ç¼“å­˜çš„è®¡ç®—ç»“æœ, è€Œä¸ä¼šå†æ¬¡æ‰§è¡Œcomputedä¸­çš„å‡½æ•°ã€‚ä½†æ˜¯methodsæ–¹æ³•ä¸­æ˜¯æ¯æ¬¡è°ƒç”¨, éƒ½ä¼šæ‰§è¡Œå‡½æ•°çš„, methodså®ƒä¸æ˜¯å“åº”å¼çš„ã€‚

9. computedä¸­çš„æˆå‘˜å¯ä»¥åªå®šä¹‰ä¸€ä¸ªå‡½æ•°ä½œä¸ºåªè¯»å±æ€§, ä¹Ÿå¯ä»¥å®šä¹‰æˆ get/setå˜æˆå¯è¯»å†™å±æ€§, ä½†æ˜¯methodsä¸­çš„æˆå‘˜æ²¡æœ‰è¿™æ ·çš„ã€‚

**ä¾¦å¬å±æ€§watchï¼š**

1.watchå®ƒæ˜¯ä¸€ä¸ªå¯¹dataçš„æ•°æ®ç›‘å¬å›è°ƒ, å½“ä¾èµ–çš„dataçš„æ•°æ®å˜åŒ–æ—¶, ä¼šæ‰§è¡Œå›è°ƒã€‚åœ¨å›è°ƒä¸­ä¼šä¼ å…¥newValå’ŒoldValä¸¤ä¸ªå‚æ•°ã€‚Vueå®åˆ—å°†ä¼šåœ¨å®ä¾‹åŒ–æ—¶è°ƒç”¨$watch(), ä»–ä¼šéå†watchå¯¹è±¡çš„æ¯ä¸€ä¸ªå±æ€§ã€‚watchçš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼šå½“åœ¨dataä¸­çš„æŸä¸ªæ•°æ®å‘ç”Ÿå˜åŒ–æ—¶, æˆ‘ä»¬éœ€è¦åšä¸€äº›æ“ä½œ, æˆ–è€…å½“éœ€è¦åœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œå¼‚æ­¥æˆ–å¼€é”€è¾ƒå¤§çš„æ“ä½œæ—¶. æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨watchæ¥è¿›è¡Œç›‘å¬ã€‚watchæ™®é€šç›‘å¬å’Œæ·±åº¦ç›‘å¬ä¸æ”¯æŒç¼“å­˜ï¼Œæ•°æ®å˜ï¼Œç›´æ¥ä¼šè§¦å‘ç›¸åº”çš„æ“ä½œï¼›

2.watché‡Œé¢æœ‰ä¸€ä¸ªå±æ€§ä¸ºdeepï¼Œå«ä¹‰æ˜¯ï¼šæ˜¯å¦æ·±åº¦ç›‘å¬æŸä¸ªå¯¹è±¡çš„å€¼, è¯¥å€¼é»˜è®¤ä¸ºfalseã€‚watchæ”¯æŒå¼‚æ­¥ï¼›

3.ç›‘å¬çš„å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€æ–°çš„å€¼ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¾“å…¥ä¹‹å‰çš„å€¼ï¼›

4.å½“ä¸€ä¸ªå±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦æ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼›ä¸€å¯¹å¤šï¼›

5.ç›‘å¬æ•°æ®å¿…é¡»æ˜¯dataä¸­å£°æ˜è¿‡æˆ–è€…çˆ¶ç»„ä»¶ä¼ é€’è¿‡æ¥çš„propsä¸­çš„æ•°æ®ï¼Œå½“æ•°æ®å˜åŒ–æ—¶ï¼Œè§¦å‘å…¶ä»–æ“ä½œï¼Œå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œ

**watch å’Œ computedçš„åŒºåˆ«æ˜¯ï¼š**

ç›¸åŒç‚¹ï¼šä»–ä»¬ä¸¤è€…éƒ½æ˜¯è§‚å¯Ÿé¡µé¢æ•°æ®å˜åŒ–çš„ã€‚

ä¸åŒç‚¹ï¼šcomputedåªæœ‰å½“ä¾èµ–çš„æ•°æ®å˜åŒ–æ—¶æ‰ä¼šè®¡ç®—, å½“æ•°æ®æ²¡æœ‰å˜åŒ–æ—¶, å®ƒä¼šè¯»å–ç¼“å­˜æ•°æ®ã€‚ watchæ¯æ¬¡éƒ½éœ€è¦æ‰§è¡Œå‡½æ•°ã€‚watchæ›´é€‚ç”¨äºæ•°æ®å˜åŒ–æ—¶çš„å¼‚æ­¥æ“ä½œã€‚

å½“éœ€è¦åœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œå¼‚æ­¥æˆ–å¼€é”€è¾ƒå¤§çš„æ“ä½œæ—¶ï¼Œè¿™ä¸ªæ–¹å¼æ˜¯æœ€æœ‰ç”¨çš„ã€‚è¿™æ˜¯å’Œcomputedæœ€å¤§çš„åŒºåˆ«ï¼Œè¯·å‹¿æ»¥ç”¨ã€‚

åœ¨ Vue ä¸­ï¼Œ`computed` å’Œ `watch` æ˜¯ä¸¤ç§ç”¨äºç›‘å¬å’Œå“åº”æ•°æ®å˜åŒ–çš„æ–¹å¼ã€‚

`computed` æ˜¯è®¡ç®—å±æ€§ï¼Œå®ƒæ˜¯åŸºäºå“åº”å¼æ•°æ®è¿›è¡Œè®¡ç®—å¾—åˆ°çš„ä¸€ä¸ªæ–°çš„æ´¾ç”Ÿå±æ€§ã€‚è®¡ç®—å±æ€§å¯ä»¥æ¥æ”¶å…¶ä»–å“åº”å¼æ•°æ®ä½œä¸ºä¾èµ–ï¼Œå¹¶ä¸”åªæœ‰å½“ä¾èµ–æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè®¡ç®—å±æ€§æ‰ä¼šé‡æ–°è®¡ç®—ã€‚è®¡ç®—å±æ€§çš„å€¼ä¼šè¢«ç¼“å­˜ï¼Œåªæœ‰åœ¨ä¾èµ–æ•°æ®å˜åŒ–æ—¶æ‰ä¼šé‡æ–°è®¡ç®—ï¼Œè¿™æ ·å¯ä»¥æé«˜æ€§èƒ½ã€‚è®¡ç®—å±æ€§çš„å®šä¹‰æ–¹å¼æ˜¯ä½¿ç”¨ `computed` å‡½æ•°æˆ–è€…åœ¨ Vue ç»„ä»¶ä¸­ä½¿ç”¨ `get` å’Œ `set` æ–¹æ³•ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨è®¡ç®—å±æ€§çš„ç¤ºä¾‹ï¼š

```javascript
import { reactive, computed } from 'vue'

const state = reactive({
  firstName: 'John',
  lastName: 'Doe'
})

const fullName = computed(() => {
  return `${state.firstName} ${state.lastName}`
})

console.log(fullName.value) // è¾“å‡º: "John Doe"

state.firstName = 'Mike' // ä¿®æ”¹firstName
console.log(fullName.value) // è¾“å‡º: "Mike Doe"
```

`watch` æ˜¯ç”¨äºç›‘å¬ç‰¹å®šå“åº”å¼æ•°æ®çš„å˜åŒ–ï¼Œå¹¶åœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚`watch` å¯ä»¥ç›‘å¬å•ä¸ªæ•°æ®çš„å˜åŒ–ï¼Œä¹Ÿå¯ä»¥ç›‘å¬å¤šä¸ªæ•°æ®çš„å˜åŒ–ã€‚å½“è¢«ç›‘å¬çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ`watch` çš„å›è°ƒå‡½æ•°ä¼šè¢«æ‰§è¡Œã€‚`watch` è¿˜æ”¯æŒæ·±åº¦ç›‘å¬å¯¹è±¡çš„å˜åŒ–ä»¥åŠå¼‚æ­¥æ“ä½œã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `watch` çš„ç¤ºä¾‹ï¼š

```javascript
import { reactive, watch } from 'vue'

const state = reactive({
  count: 0
})

watch(() => state.count, (newVal, oldVal) => {
  console.log(`count ä» ${oldVal} å˜ä¸º ${newVal}`)
})

state.count++ // è¾“å‡º: "count ä» 0 å˜ä¸º 1"
```

ä»¥ä¸Šæ˜¯ `computed` å’Œ `watch` çš„åŸºæœ¬ç”¨æ³•ã€‚é€šè¿‡ä½¿ç”¨è¿™ä¸¤ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ç›‘å¬å’Œå“åº”æ•°æ®çš„å˜åŒ–ï¼Œå®ç°æ›´åŠ çµæ´»çš„é€»è¾‘å’Œäº¤äº’ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªè¡¨æ ¼ï¼Œå¯¹æ¯”äº† Vue 3 ä¸­çš„ `computed` è®¡ç®—å±æ€§å’Œæ™®é€šå‡½æ•°æ–¹æ³•çš„ä¸»è¦å·®å¼‚ï¼š

| ç‰¹æ€§ | è®¡ç®—å±æ€§ (`computed`) | æ™®é€šå‡½æ•°æ–¹æ³• (`methods`) |
| ------------ | -------------------------------------------------------- | ------------------------------------------------------ |
| **ç¼“å­˜** | æ˜¯ã€‚åªæœ‰å½“ä¾èµ–æ•°æ®å˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—ã€‚ | å¦ã€‚æ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ‰§è¡Œå‡½æ•°é€»è¾‘ã€‚ |
| **æ€§èƒ½** | é«˜ã€‚é¿å…äº†ä¸å¿…è¦çš„è®¡ç®—ï¼Œåªåœ¨ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—ã€‚ | è¾ƒä½ã€‚ä¸åŒºåˆ†æ˜¯å¦æœ‰æ•°æ®æ›´æ–°ï¼Œéƒ½ä¼šæ‰§è¡Œã€‚ |
| **è§¦å‘æ›´æ–°** | ä¾èµ–æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ã€‚ | éœ€è¦æ‰‹åŠ¨è§¦å‘æˆ–ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶æ‰æ›´æ–°ã€‚ |
| **ä½¿ç”¨åœºæ™¯** | å½“æ•°æ®å˜åŒ–éœ€è¦è¿›è¡Œå¤æ‚è¿ç®—æ—¶ï¼Œä¸”ç»“æœè¦è¢«å¤šæ¬¡å¼•ç”¨ã€‚ | æ¯æ¬¡éƒ½éœ€æ‰§è¡Œæ–°é€»è¾‘æˆ–æ“ä½œä¸ä¾èµ–å“åº”å¼æ•°æ®æ—¶ã€‚ |
| **è®¿é—®æ–¹å¼** | å¦‚è®¿é—®å±æ€§ä¸€æ ·ï¼Œä¸éœ€è¦åŠ æ‹¬å·ã€‚ | åœ¨æ¨¡æ¿ä¸­è°ƒç”¨æ—¶éœ€è¦åŠ æ‹¬å·ã€‚ |
| **è¿”å›å€¼** | è°ƒç”¨æ—¶è¿”å›è®¡ç®—åçš„ç»“æœï¼Œä¸éœ€è¦æ‰§è¡Œä»»ä½•å‡½æ•°ã€‚ | å¿…é¡»æ‰§è¡Œå‡½æ•°ä»¥è·å–ç»“æœã€‚ |
| **æ›´æ–°æ€§èƒ½** | åªåœ¨ä¾èµ–å˜åŒ–æ—¶é‡æ–°æ±‚å€¼ï¼Œå¦‚æœä¾èµ–æœªå˜åŒ–åˆ™è¿”å›ä¸Šæ¬¡çš„ç»“æœã€‚ | åœ¨æ¯æ¬¡è®¿é—®æˆ–è°ƒç”¨æ—¶æ— æ¡ä»¶æ‰§è¡Œï¼Œä¸è€ƒè™‘ä¾èµ–æ•°æ®æ˜¯å¦å˜åŒ–ã€‚ |

é€šè¿‡å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤è€…åœ¨ Vue åº”ç”¨ä¸­å„è‡ªçš„ä¼˜åŠ¿å’Œåº”ç”¨åœºæ™¯ã€‚`computed` é€‚åˆç”¨äºåŸºäºæ•°æ®å˜åŒ–éœ€è¦é‡æ–°è®¡ç®—çš„åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯å½“è¿™äº›è®¡ç®—æ¯”è¾ƒæ˜‚è´µï¼Œæˆ–è€…è®¡ç®—ç»“æœä¼šè¢«å¤šå¤„ä½¿ç”¨æ—¶ã€‚è€Œæ™®é€šå‡½æ•°æ–¹æ³•æ›´é€‚åˆç”¨äºæ‰§è¡Œä¸ä¾èµ–å“åº”å¼æ•°æ®çš„æ“ä½œï¼Œæˆ–è€…å½“æ“ä½œæ¯æ¬¡éƒ½éœ€è¦äº§ç”Ÿä¸åŒç»“æœæ—¶ã€‚æ­£ç¡®åœ°é€‰æ‹©ä½¿ç”¨è®¡ç®—å±æ€§è¿˜æ˜¯æ™®é€šæ–¹æ³•ï¼Œå¯ä»¥ä¼˜åŒ–ä½ çš„ Vue åº”ç”¨çš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

* computed æ˜¯è®¡ç®—å±æ€§ï¼Œæœ‰ç¼“å­˜ï¼Œä¾èµ–å˜åŒ–æ‰ä¼šé‡æ–°è®¡ç®—
* watch æ˜¯ç›‘å¬å™¨ï¼Œç”¨äºå“åº”æ•°æ®å˜åŒ–æ‰§è¡Œå›è°ƒ
* computed é€‚åˆå¤šä¸ªæ•°æ®å½±å“ä¸€ä¸ªæ•°æ®çš„åœºæ™¯

```javascript
// computed ç¤ºä¾‹ï¼šè®¡ç®—æ€»ä»·
const config = {
  computed: {
    total () {
      return this.price * this.quantity
    }
  }
}
```

* watch é€‚åˆä¸€ä¸ªæ•°æ®å˜åŒ–å½±å“å¤šä¸ªæ•°æ®çš„åœºæ™¯

```javascript
// watch ç¤ºä¾‹ï¼šæ•°æ®å˜åŒ–æ‰§è¡Œå¤šä¸ªæ“ä½œ
const config = {
  watch: {
    username (newVal) {
      this.validateUsername(newVal)
      this.checkAvailability(newVal)
      this.updateUserProfile(newVal)
    }
  }
}
```

1. scoped style åŸç†:

* é€šè¿‡ç»™ç»„ä»¶æ·»åŠ å”¯ä¸€çš„å±æ€§æ ‡è¯†ç¬¦(data-v-hash)
* ç¼–è¯‘æ—¶ç»™ css é€‰æ‹©å™¨æ·»åŠ å¯¹åº”çš„å±æ€§é€‰æ‹©å™¨
* ç¡®ä¿æ ·å¼åªä½œç”¨äºå½“å‰ç»„ä»¶

5. å‚ç›´å±…ä¸­å®ç°:

```css
/* Flex æ–¹å¼ */
.parent {
display: flex;
align-items: center;
justify-content: center;
}

/* Grid æ–¹å¼ */
.parent {
display: grid;
place-items: center;
}

/* ç»å¯¹å®šä½æ–¹å¼ */
.child {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
}
```

6. flex: 1 çš„å«ä¹‰:
ç›¸å½“äºè®¾ç½®:

```css
flex-grow: 1;
flex-shrink: 1;
flex-basis: 0%;
```

è¡¨ç¤ºå…ƒç´ å¯ä»¥ä¼¸å±•å’Œæ”¶ç¼©ï¼Œå æ®å‰©ä½™ç©ºé—´

7. å•è¡Œæ–‡æœ¬çœç•¥:

```css
.ellipsis {
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
```

8. apply å’Œ call çš„åŒºåˆ«:

* éƒ½æ˜¯ç”¨æ¥æ”¹å˜å‡½æ•°çš„ this æŒ‡å‘
* call æ¥å—å‚æ•°åˆ—è¡¨
* apply æ¥å—å‚æ•°æ•°ç»„

```javascript
fn.call(obj, arg1, arg2)
fn.apply(obj, [arg1, arg2])
```

9. this æŒ‡å‘:

* æ™®é€šå‡½æ•°ä¸­ï¼Œthis æŒ‡å‘è°ƒç”¨è€…
* ç®­å¤´å‡½æ•°ä¸­ï¼Œthis æŒ‡å‘å®šä¹‰æ—¶çš„ä¸Šä¸‹æ–‡
* call/apply/bind å¯ä»¥æ”¹å˜ this æŒ‡å‘
* æ„é€ å‡½æ•°ä¸­ï¼Œthis æŒ‡å‘æ–°åˆ›å»ºçš„å®ä¾‹

10. é—­åŒ…åŠåœºæ™¯:
é—­åŒ…æ˜¯å‡½æ•°èƒ½å¤Ÿè®¿é—®å…¶å®šä¹‰æ—¶æ‰€åœ¨çš„è¯æ³•ä½œç”¨åŸŸ
å¸¸è§åœºæ™¯:

```javascript
// æ•°æ®ç§æœ‰åŒ–
function counter () {
  let count = 0
  return {
    add () { count++ },
    get () { return count }
  }
}

// å‡½æ•°æŸ¯é‡ŒåŒ–
function curry (fn) {
  return function curried (...args) {
    if (args.length >= fn.length) {
      return fn.apply(this, args)
    }
    return function (...moreArgs) {
      return curried.apply(this, args.concat(moreArgs))
    }
  }
}
```

11. èŠ‚æµé˜²æŠ–:

```javascript
// é˜²æŠ–: å»¶è¿Ÿæ‰§è¡Œï¼Œé‡å¤è§¦å‘é‡æ–°è®¡æ—¶
function debounce (fn, delay) {
  let timer = null
  return function (...args) {
    clearTimeout(timer)
    timer = setTimeout(() => {
      fn.apply(this, args)
    }, delay)
  }
}

// èŠ‚æµ: è§„å®šæ—¶é—´å†…åªæ‰§è¡Œä¸€æ¬¡
function throttle (fn, delay) {
  let timer = null
  return function (...args) {
    if (!timer) {
      timer = setTimeout(() => {
        fn.apply(this, args)
        timer = null
      }, delay)
    }
  }
}
```

12. å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡:

* å®ä»»åŠ¡: setTimeout, setInterval, requestAnimationFrame
* å¾®ä»»åŠ¡: Promise, MutationObserver, process.nextTick
* æ‰§è¡Œé¡ºåº: åŒæ­¥ä»£ç  -> å¾®ä»»åŠ¡é˜Ÿåˆ— -> å®ä»»åŠ¡é˜Ÿåˆ—

13. async/await:

* async å‡½æ•°è¿”å› Promise
* await ç­‰å¾… Promise å®Œæˆ
* ç”¨åŒæ­¥çš„å†™æ³•å®ç°å¼‚æ­¥æ“ä½œ

```javascript
async function example () {
  try {
    const result = await someAsyncOperation()
    return result
  } catch (error) {
    console.error(error)
  }
}
```

14. ç”Ÿæˆå™¨:

```javascript
function * generator () {
  yield 1
  yield 2
  return 3
}

const gen = generator()
console.log(gen.next()) // {value: 1, done: false}
console.log(gen.next()) // {value: 2, done: false}
console.log(gen.next()) // {value: 3, done: true}
```

15. TypeScript ä¸­ type å’Œ interface çš„åŒºåˆ«:

* interface å¯ä»¥å£°æ˜åˆå¹¶ï¼Œtype ä¸è¡Œ
* interface åªèƒ½å£°æ˜å¯¹è±¡ç±»å‹ï¼Œtype å¯ä»¥å£°æ˜ä»»æ„ç±»å‹
* type å¯ä»¥ä½¿ç”¨è”åˆç±»å‹å’Œäº¤å‰ç±»å‹
* interface å¯ä»¥ extends å’Œ implements

```typescript
// interface åˆå¹¶
interface User {
name: string;
}
interface User {
age: number;
}

// type è”åˆç±»å‹
type Status = 'pending' | 'fulfilled' | 'rejected';
```

16. Vue å“åº”å¼åŸç†åŠ Vue2/Vue3 åŒºåˆ«:

**å“åº”å¼å®šä¹‰**ï¼š

* æ•°æ®çš„å˜åŒ–è‡ªåŠ¨è§¦å‘ç›¸å…³è”çš„æ›´æ–°æ“ä½œ
* å®ç°äº†æ•°æ®ä¸è§†å›¾çš„åŒæ­¥

**Vue2 å®ç° (Object.defineProperty)**:

```javascript
Object.defineProperty(obj, 'key', {
  get () {
  // ä¾èµ–æ”¶é›†
    track()
    return value
  },
  set (newValue) {
    value = newValue
    // è§¦å‘æ›´æ–°
    trigger()
  }
})
```

**Vue3 å®ç° (Proxy)**:

```javascript
const proxy = new Proxy(target, {
  get (target, key) {
  // ä¾èµ–æ”¶é›†
    track(target, key)
    return target[key]
  },
  set (target, key, value) {
    target[key] = value
    // è§¦å‘æ›´æ–°
    trigger(target, key)
    return true
  }
})
```

**Vue2 å±€é™æ€§**:

* æ— æ³•æ£€æµ‹å¯¹è±¡å±æ€§çš„æ·»åŠ å’Œåˆ é™¤
* æ— æ³•ç›´æ¥ç›‘å¬æ•°ç»„ç´¢å¼•å’Œé•¿åº¦å˜åŒ–
* éœ€è¦é€’å½’éå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§
* éœ€è¦ä½¿ç”¨ Vue.set æˆ– this.$set æ·»åŠ å“åº”å¼å±æ€§

**Vue3 ä¼˜åŠ¿**:

* å¯ä»¥ç›‘å¬åŠ¨æ€æ·»åŠ çš„å±æ€§
* å¯ä»¥ç›‘å¬æ•°ç»„çš„ç´¢å¼•å’Œé•¿åº¦å˜åŒ–
* æ”¯æŒ Mapã€Setã€WeakMapã€WeakSet
* æ€§èƒ½æ›´å¥½ï¼Œä¸éœ€è¦åˆå§‹åŒ–æ—¶é€’å½’
* æ›´å¥½çš„ç±»å‹æ¨å¯¼æ”¯æŒ

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```javascript
// Vue2 çš„å±€é™
const vm = new Vue({
  data: {
    items: ['a', 'b']
  }
})
vm.items[0] = 'x' // ä¸ä¼šè§¦å‘å“åº”
vm.items.length = 1 // ä¸ä¼šè§¦å‘å“åº”

// Vue3 çš„ä¼˜åŠ¿
const proxy = reactive({
  items: ['a', 'b']
})
proxy.items[0] = 'x' // å¯ä»¥è§¦å‘å“åº”
proxy.items.length = 1 // å¯ä»¥è§¦å‘å“åº”
```

## Provide inject {#p2-provide-inject}

Vue 3 ä¸­çš„ `provide` å’Œ `inject` åŠŸèƒ½æä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œå…è®¸ç¥–å…ˆç»„ä»¶å°†æ•°æ®â€œæä¾›â€ç»™å®ƒçš„æ‰€æœ‰åä»£ç»„ä»¶ï¼Œæ— è®ºåä»£ç»„ä»¶ä½äºç»„ä»¶æ ‘çš„ä½•å¤„ï¼Œè€Œä¸å¿…é€šè¿‡æ‰€æœ‰çš„ç»„ä»¶å±‚å±‚ä¼ é€’å±æ€§ï¼ˆpropsï¼‰ã€‚è¿™å¯¹äºæ·±å±‚åµŒå¥—çš„ç»„ä»¶æˆ–è·¨å¤šä¸ªç»„ä»¶å…±äº«çŠ¶æ€ç‰¹åˆ«æœ‰ç”¨ã€‚

 åŸºæœ¬ç”¨æ³•

 åœ¨ç¥–å…ˆç»„ä»¶ä¸­æä¾›æ•°æ®

ä½ å¯ä»¥åœ¨ä»»ä½•ç»„ä»¶ä¸­ä½¿ç”¨ `provide` é€‰é¡¹æ¥æä¾›æ•°æ®ã€‚`provide` é€‰é¡¹åº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–è¿”å›å¯¹è±¡çš„å‡½æ•°ï¼Œå…¶ä¸­çš„æ¯ä¸ªå±æ€§éƒ½å¯ä»¥è¢«å­ç»„ä»¶æ³¨å…¥ã€‚ä» Vue 3 å¼€å§‹ï¼Œ`provide` å’Œ `inject` ç»‘å®šç°åœ¨æ˜¯å“åº”å¼çš„ã€‚

åœ¨ Vue 3 ä¸­ï¼Œå»ºè®®åœ¨ `setup()` å‡½æ•°ä¸­ä½¿ç”¨ `provide` å‡½æ•°ï¼Œå› ä¸º `setup` æ˜¯ç»„åˆå¼ API çš„å…¥å£ç‚¹ã€‚

```javascript
import { provide } from 'vue'

export default {
  setup () {
    // æä¾› 'theme' æ•°æ®
    provide('theme', 'dark')
  }
}
```

 åœ¨åä»£ç»„ä»¶ä¸­æ³¨å…¥æ•°æ®

åä»£ç»„ä»¶å¯ä»¥ä½¿ç”¨ `inject` é€‰é¡¹æ¥æ¥æ”¶æ•°æ®ã€‚`inject` é€‰é¡¹åº”è¯¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œåˆ—å‡ºéœ€è¦æ³¨å…¥çš„å±æ€§åã€‚

```javascript
import { inject } from 'vue'

export default {
  setup () {
    const theme = inject('theme')
    return { theme }
  }
}
```

 æ¡ˆä¾‹

å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªåº”ç”¨ï¼Œè¯¥åº”ç”¨æœ‰ä¸€ä¸ªä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨é¡¶å±‚ç»„ä»¶ä¸­æä¾›å½“å‰ä¸»é¢˜ï¼Œè€Œæ‰€æœ‰å­ç»„ä»¶éƒ½å¯ä»¥æ³¨å…¥è¿™ä¸ªä¸»é¢˜ä¿¡æ¯ï¼Œè€Œä¸å¿…é€šè¿‡å±‚å±‚ä¼ é€’ã€‚

 å“åº”å¼æä¾›

å¦‚æœè¦æä¾›çš„æ•°æ®æ˜¯å“åº”å¼çš„ï¼Œå¹¶ä¸”å¸Œæœ›åä»£ç»„ä»¶èƒ½å¤Ÿå“åº”æ•°æ®çš„å˜åŒ–ï¼Œä½ éœ€è¦ä½¿ç”¨ Vue çš„å“åº”å¼ç³»ç»Ÿå‡½æ•°ï¼Œä¾‹å¦‚ `reactive` æˆ– `ref`ã€‚

```javascript
import { provide, reactive } from 'vue'

export default {
  setup () {
    const theme = reactive({ color: 'dark' })
    provide('theme', theme)
  }
}
```

åä»£ç»„ä»¶åŒæ ·å¯ä»¥å¦‚ä¸Šæ‰€ç¤ºé€šè¿‡ `inject` è·å–è¿™ä¸ªå“åº”å¼çš„æ•°æ®ã€‚

 æ³¨æ„äº‹é¡¹

* `provide` å’Œ `inject` æä¾›çš„ä¾èµ–å…³ç³»ä¸æ˜¯å¯é çš„ï¼Œå¹¶ä¸”ä¸åº”è¯¥åœ¨ä¸šåŠ¡é€»è¾‘ä¸­é¢‘ç¹ä½¿ç”¨ï¼Œä»¥é¿å…å¤æ‚çš„è·¨ç»„ä»¶é€šè®¯å¯¼è‡´åº”ç”¨éš¾ä»¥ç»´æŠ¤ã€‚å®ƒé€šå¸¸è¢«ç”¨äºå¼€å‘å¯å¤ç”¨çš„æ’ä»¶æˆ–é«˜é˜¶ç»„ä»¶ã€‚
* ä½¿ç”¨è¿™ä¸¤ä¸ªé€‰é¡¹æ—¶ï¼Œæ³¨å…¥çš„æ•°æ®åœ¨åä»£ç»„ä»¶ä¸­å¹¶ä¸æ˜¯å“åº”å¼çš„ï¼Œé™¤éä½¿ç”¨äº† Vue çš„å“åº”å¼ç³»ç»Ÿï¼ˆå¦‚ `reactive`ã€`ref`ï¼‰æ¥æä¾›è¿™äº›æ•°æ®ã€‚
* å¦‚æœ `inject` æœªæ‰¾åˆ°æä¾›çš„é”®ï¼Œåˆ™å®ƒé»˜è®¤è¿”å› `undefined`ã€‚ä½ å¯ä»¥é€šè¿‡æä¾›ç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºé»˜è®¤å€¼æ¥æ”¹å˜è¿™ä¸€è¡Œä¸ºã€‚

æ€»çš„æ¥è¯´ï¼Œ`provide` å’Œ `inject` æ˜¯ Vue 3 ä¸­è§£å†³è·¨å¤šä¸ªç»„ä»¶å…±äº«çŠ¶æ€é—®é¢˜çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå°¤å…¶é€‚ç”¨äºå¼€å‘é«˜é˜¶ç»„ä»¶æˆ–æ’ä»¶æ—¶ä½¿ç”¨ã€‚

## watchEffect {#p2-wactheffect}

## watch å’Œ watchEffect åœºæ™¯ä¸Šæœ‰ä½•åŒºåˆ« {#p2-watch-and-watcheffect}

`watch` å’Œ `watchEffect` åœ¨ Vue 3 ä¸­éƒ½æ˜¯å¼ºå¤§çš„å“åº”å¼ç‰¹æ€§ï¼Œç”¨äºä¾¦å¬å“åº”å¼çŠ¶æ€çš„å˜åŒ–å¹¶æ‰§è¡Œä¸€äº›å‰¯ä½œç”¨ï¼ˆå¦‚è°ƒç”¨å‡½æ•°ï¼‰ã€‚è™½ç„¶å®ƒä»¬å¾ˆç›¸ä¼¼ï¼Œä½†åœ¨ä½¿ç”¨åœºæ™¯å’Œè¡Œä¸ºä¸Šæœ‰ä¸€äº›å…³é”®çš„åŒºåˆ«ï¼Œäº†è§£è¿™äº›åŒºåˆ«å¯ä»¥å¸®åŠ©ä½ é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·æ¥å®ç°ä½ çš„éœ€æ±‚ã€‚

 watch

* **ç²¾ç¡®æ€§**ï¼š`watch` å…è®¸ä½ æ˜ç¡®æŒ‡å®šè¦ä¾¦å¬çš„æ•°æ®æºï¼Œå¹¶ä¸”å¯ä»¥åˆ†åˆ«è®¿é—®å…¶æ–°å€¼å’Œæ—§å€¼ã€‚è¿™è®© `watch` åœ¨éœ€è¦å¯¹ç‰¹å®šæ•°æ®å˜åŒ–åšå‡ºå“åº”æ—¶éå¸¸ç²¾ç¡®å’Œçµæ´»ã€‚
* **æƒ°æ€§æ‰§è¡Œ**ï¼š`watch` é»˜è®¤æƒ…å†µä¸‹æ˜¯æƒ°æ€§æ‰§è¡Œçš„ï¼Œå³å®ƒéœ€è¦æ•°æ®å‘ç”Ÿå˜åŒ–åæ‰æ‰§è¡Œå›è°ƒã€‚è¿™æ„å‘³ç€åœ¨åˆå§‹åŒ–æ—¶ï¼Œ`watch` çš„å›è°ƒä¸ä¼šæ‰§è¡Œï¼Œé™¤éä½ é€šè¿‡é…ç½®ä½¿å…¶ç«‹å³æ‰§è¡Œã€‚
* **ä½¿ç”¨åœºæ™¯**ï¼šå½“ä½ éœ€è¦æ˜ç¡®çŸ¥é“æ•°æ®ä½•æ—¶æ”¹å˜ä»¥åŠå¦‚ä½•æ”¹å˜æ—¶ï¼ˆä¾‹å¦‚å¯¹æ¯”æ–°æ—§å€¼ï¼‰ï¼Œæˆ–è€…éœ€è¦ä¾¦å¬ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®šçš„å“åº”å¼å¼•ç”¨æ—¶ï¼Œ`watch` æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

 watchEffect

* **è‡ªåŠ¨ä¾¦æµ‹**ï¼š`watchEffect` ä¼šè‡ªåŠ¨ä¾¦æµ‹å…¶å›è°ƒå‡½æ•°ä¸­ç”¨åˆ°çš„å“åº”å¼çŠ¶æ€ï¼Œå¹¶åœ¨è¿™äº›çŠ¶æ€æ”¹å˜æ—¶é‡æ–°æ‰§è¡Œã€‚è¿™æ„å‘³ç€ä½ ä¸éœ€è¦æ˜ç¡®æŒ‡å®šä¾¦å¬çš„çŠ¶æ€ï¼Œè®©ä¾¦å¬å‰¯ä½œç”¨çš„ç¼–å†™æ›´ç®€å•ç›´æ¥ã€‚
* **ç«‹å³æ‰§è¡Œ**ï¼š`watchEffect` å›è°ƒä¼šåœ¨åˆå§‹æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åå†æ¯æ¬¡ä¾èµ–çš„å“åº”å¼çŠ¶æ€å˜åŒ–æ—¶å†æ¬¡æ‰§è¡Œã€‚è¿™é€‚åˆäºä¸éœ€è¦åˆå§‹æ¡ä»¶åˆ¤æ–­ä¸”å¸Œæœ›ç«‹å³æ ¹æ®å“åº”å¼çŠ¶æ€æ¸²æŸ“æˆ–æ‰§è¡Œé€»è¾‘çš„åœºæ™¯ã€‚
* **ä½¿ç”¨åœºæ™¯**ï¼šå½“ä½ éœ€è¦è‡ªåŠ¨è¿½è¸ªå¹¶å“åº”æ‰€æœ‰ä½¿ç”¨åˆ°çš„å“åº”å¼çŠ¶æ€å˜åŒ–æ—¶ï¼Œ`watchEffect` æ˜¯æ›´ä¾¿æ·çš„é€‰é¡¹ã€‚å®ƒé€‚ç”¨äºä¾èµ–é¡¹ä¸æ˜ç¡®æˆ–è€…å¸Œæœ›è‡ªåŠ¨è¿½è¸ªä¾èµ–å¹¶æ‰§è¡Œå‰¯ä½œç”¨çš„åœºåˆã€‚

 å¦‚ä½•é€‰æ‹©

1. **å¦‚æœä½ çš„å‰¯ä½œç”¨é€»è¾‘éœ€è¦æ˜ç¡®ä¾¦å¬ç‰¹å®šçš„æ•°æ®æºï¼Œå¹¶ä¸”éœ€è¦åŒºåˆ†åˆå§‹æ‰§è¡Œå’Œä¾èµ–æ›´æ–°æ—¶çš„é€»è¾‘**ï¼Œé‚£ä¹ˆä½¿ç”¨ `watch` æ›´åˆé€‚ã€‚`watch` æä¾›äº†å¯¹ä¾¦å¬æ•°æ®å’Œæ‰§è¡Œé€»è¾‘çš„ç»†ç²’åº¦æ§åˆ¶ã€‚
2. **å¦‚æœä½ çš„é€»è¾‘åªæ˜¯å•çº¯åœ°éœ€è¦å¯¹ä½¿ç”¨åˆ°çš„ä»»ä½•å“åº”å¼çŠ¶æ€çš„æ”¹å˜åšå‡ºå“åº”ï¼Œä¸”å¸Œæœ›ç®€åŒ–ä¾èµ–è·Ÿè¸ª**ï¼Œ`watchEffect` æ›´ç®€å•ã€æ›´æ˜“äºä½¿ç”¨ã€‚å®ƒè‡ªåŠ¨æ”¶é›†ä¾èµ–é¡¹ï¼Œç®€åŒ–äº†ä»£ç ï¼Œä½¿ä½ çš„å‰¯ä½œç”¨é€»è¾‘æ›´å®¹æ˜“ç¼–å†™å’Œç»´æŠ¤ã€‚

é€šå¸¸ï¼Œé€‰æ‹©ä¾èµ–äºä½ æƒ³è¦çš„æ§åˆ¶çº§åˆ«å’Œç‰¹å®šçš„ä½¿ç”¨æƒ…å†µã€‚`watch` æä¾›äº†æ›´é«˜çš„çµæ´»æ€§å’Œæ§åˆ¶åŠ›ï¼Œ`watchEffect` åˆ™ä¸ºå¸¸è§çš„è‡ªåŠ¨å“åº”é€»è¾‘æä¾›äº†ä¾¿åˆ©ã€‚äº†è§£è¿™äº›åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯å¯ä»¥å¸®åŠ©ä½ æ›´åˆç†åœ°ä½¿ç”¨ Vue 3 çš„å“åº”å¼ç³»ç»Ÿã€‚
